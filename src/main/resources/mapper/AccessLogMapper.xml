<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.part.mapper.AccessLogMapper">

    <resultMap id="accessLogResultMap" type="com.example.part.dto.AccessLogDTO">
        <id property="logId" column="log_id"/>
        <result property="userId" column="user_id"/>
        <result property="username" column="username"/>
        <result property="loginTime" column="login_time"/>
        <result property="logoutTime" column="logout_time"/>
        <result property="ipAddress" column="ip_address"/>
        <result property="logoutIp" column="logout_ip"/>
        <result property="userAgent" column="user_agent"/>
        <result property="sessionId" column="session_id"/>
    </resultMap>

    <insert id="insertAccessLog" parameterType="com.example.part.dto.AccessLogDTO"
            useGeneratedKeys="true" keyProperty="logId">
        INSERT INTO user_access_logs (user_id, username, login_time, ip_address, user_agent, session_id)
        VALUES (#{userId}, #{username}, #{loginTime}, #{ipAddress}, #{userAgent}, #{sessionId})
    </insert>

    <update id="updateLogoutTime">
        UPDATE user_access_logs
        SET logout_time = #{logoutTime},
            logout_ip = #{logoutIp}
        WHERE session_id = #{sessionId}
        AND logout_time IS NULL
    </update>

    <select id="selectAllAccessLogs" resultMap="accessLogResultMap">
        SELECT * FROM user_access_logs
        ORDER BY login_time DESC
        LIMIT 1000
    </select>

    <select id="selectAccessLogsByUserId" resultMap="accessLogResultMap" parameterType="int">
        SELECT * FROM user_access_logs
        WHERE user_id = #{userId}
        ORDER BY login_time DESC
    </select>

    <select id="selectAccessLogBySessionId" resultMap="accessLogResultMap" parameterType="string">
        SELECT * FROM user_access_logs
        WHERE session_id = #{sessionId}
        ORDER BY login_time DESC
        LIMIT 1
    </select>

</mapper>
