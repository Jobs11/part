<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.part.mapper.PartsMapper">

    <!-- ResultMap 정의 -->
    <resultMap id="partsResultMap" type="com.example.part.dto.PartsDTO">
        <id property="partNumber" column="part_number"/>
        <result property="partName" column="part_name"/>
        <result property="quantity" column="quantity"/>
        <result property="unit" column="unit"/>
        <result property="description" column="description"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- 부품 입력 -->
    <insert id="insertPart" parameterType="com.example.part.dto.PartsDTO">
        INSERT INTO parts (
            part_number,
            part_name,
            quantity,
            unit,
            description
        ) VALUES (
            #{partNumber},
            #{partName},
            #{quantity},
            #{unit},
            #{description}
        )
    </insert>

    <!-- 부품 수정 -->
    <update id="updatePart" parameterType="com.example.part.dto.PartsDTO">
        UPDATE parts
        SET
            part_name = #{partName},
            quantity = #{quantity},
            unit = #{unit},
            description = #{description}
        WHERE part_number = #{partNumber}
    </update>

    <!-- 수량이 지정된 값 이하인 부품 리스트 조회 (기본값 10) -->
    <select id="selectLowStockParts" resultMap="partsResultMap" parameterType="int">
        SELECT
            part_number,
            part_name,
            quantity,
            unit,
            description,
            created_at,
            updated_at,
            del_status
        FROM parts
        WHERE quantity &lt;= #{threshold}
          AND del_status = '공개'
        ORDER BY quantity ASC, part_number ASC
    </select>

    <!-- 전체 부품 리스트 조회 -->
    <select id="selectAllParts" resultMap="partsResultMap">
        SELECT
            part_number,
            part_name,
            quantity,
            unit,
            description,
            created_at,
            updated_at,
            del_status
        FROM parts
        WHERE del_status = '공개'
        ORDER BY part_number ASC
    </select>

    <!-- 부품 재고 차감 -->
    <update id="decreaseQuantity">
        UPDATE parts
        SET quantity = quantity - #{quantity}
        WHERE part_number = #{partNumber}
          AND quantity &gt;= #{quantity}
    </update>

    <!-- 부품 재고 증가 -->
    <update id="increaseQuantity">
        UPDATE parts
        SET quantity = quantity + #{quantity}
        WHERE part_number = #{partNumber}
          AND quantity &gt;= #{quantity}
    </update>

    <!-- 내림차순 정렬 -->
    <select id="getPartsOrderByDesc" resultType="com.example.part.dto.PartsDTO">
        SELECT
            part_number,
            part_name,
            quantity,
            unit,
            description,
            created_at,
            updated_at,
            del_status
        FROM parts
        WHERE del_status = '공개'
        ORDER BY ${column} DESC
    </select>

    <!-- 오름차순 정렬 -->
    <select id="getPartsOrderByAsc" resultType="com.example.part.dto.PartsDTO">
        SELECT
            part_number,
            part_name,
            quantity,
            unit,
            description,
            created_at,
            updated_at,
            del_status
        FROM parts
        WHERE del_status = '공개'
        ORDER BY ${column} ASC
    </select>

    <!-- 부품번호로 단일 조회 -->
    <select id="findByPartNumber" resultType="com.example.part.dto.PartsDTO">
        SELECT *
        FROM parts
        WHERE part_number = #{partNumber}
          AND del_status = '공개'
    </select>

    <update id="updateQuantityAbsolute">
        UPDATE parts
        SET quantity = #{quantity}
        WHERE part_number = #{partNumber}
    </update>

    <!-- 부품 비공개 처리 (Soft Delete) -->
    <update id="softDeletePart" parameterType="string">
        UPDATE parts
        SET del_status = '비공개'
        WHERE part_number = #{partNumber}
    </update>

</mapper>
