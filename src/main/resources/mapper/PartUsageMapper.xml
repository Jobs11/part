<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.part.mapper.PartUsageMapper">

    <!-- ResultMap 정의 -->
    <resultMap id="usageResultMap" type="com.example.part.dto.PartUsageDTO">
        <id property="usageId" column="usage_id"/>
        <result property="incomingId" column="incoming_id"/>
        <result property="partNumber" column="part_number"/>
        <result property="partName" column="part_name"/>
        <result property="categoryName" column="category_name"/>
        <result property="unit" column="unit"/>
        <result property="quantityUsed" column="quantity_used"/>
        <result property="usageLocation" column="usage_location"/>
        <result property="usedDate" column="used_date"/>
        <result property="note" column="note"/>
        <result property="createdBy" column="created_by"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <!-- ✅ 출고(사용) 등록 -->
    <insert id="insertPartUsage" parameterType="com.example.part.dto.PartUsageDTO" useGeneratedKeys="true" keyProperty="usageId">
        INSERT INTO part_usage (
            incoming_id,
            part_number,
            quantity_used,
            usage_location,
            used_date,
            note,
            created_by
        ) VALUES (
            #{incomingId},
            #{partNumber},
            #{quantityUsed},
            #{usageLocation},
            #{usedDate},
            #{note},
            #{createdBy}
        )
    </insert>

    <!-- ✅ 출고 수정 -->
    <update id="updatePartUsage" parameterType="com.example.part.dto.PartUsageDTO">
        UPDATE part_usage
        SET
            quantity_used = #{quantityUsed},
            usage_location = #{usageLocation},
            used_date = #{usedDate},
            note = #{note}
        WHERE usage_id = #{usageId}
    </update>

    <!-- ✅ usage_id로 단건 조회 -->
    <select id="findById" resultMap="usageResultMap" parameterType="int">
        SELECT
            pu.*,
            pi.part_name,
            pi.unit,
            c.category_name
        FROM part_usage pu
        LEFT JOIN part_incoming pi ON pu.incoming_id = pi.incoming_id
        LEFT JOIN category c ON pi.category_id = c.category_id
        WHERE pu.usage_id = #{usageId}
    </select>

    <!-- ✅ 전체 사용 내역 -->
    <select id="selectAllUsage" resultMap="usageResultMap">
        SELECT
            pu.*,
            pi.part_name,
            pi.unit,
            c.category_name
        FROM part_usage pu
        LEFT JOIN part_incoming pi ON pu.incoming_id = pi.incoming_id
        LEFT JOIN category c ON pi.category_id = c.category_id
        ORDER BY pu.used_date DESC, pu.created_at DESC
    </select>

    <!-- ✅ 검색 기능 (부품명, 사용처, 부품번호 동시 검색) -->
    <select id="searchUsage" resultMap="usageResultMap" parameterType="string">
        SELECT
            pu.*,
            pi.part_name,
            pi.unit,
            c.category_name
        FROM part_usage pu
        LEFT JOIN part_incoming pi ON pu.incoming_id = pi.incoming_id
        LEFT JOIN category c ON pi.category_id = c.category_id
        WHERE
            pi.part_name LIKE CONCAT('%', #{keyword}, '%')
            OR pu.usage_location LIKE CONCAT('%', #{keyword}, '%')
            OR pu.part_number LIKE CONCAT('%', #{keyword}, '%')
        ORDER BY pu.used_date DESC
    </select>

    <!-- ✅ 사용처별 조회 -->
    <select id="selectUsageByLocation" parameterType="string" resultMap="usageResultMap">
        SELECT
            pu.*,
            pi.part_name,
            pi.unit,
            c.category_name
        FROM part_usage pu
        LEFT JOIN part_incoming pi ON pu.incoming_id = pi.incoming_id
        LEFT JOIN category c ON pi.category_id = c.category_id
        WHERE pu.usage_location LIKE CONCAT('%', #{usageLocation}, '%')
        ORDER BY pu.used_date DESC
    </select>

    <!-- ✅ 부품번호별 조회 -->
    <select id="selectUsageByPartNumber" parameterType="string" resultMap="usageResultMap">
        SELECT
            pu.*,
            pi.part_name,
            pi.unit,
            c.category_name
        FROM part_usage pu
        LEFT JOIN part_incoming pi ON pu.incoming_id = pi.incoming_id
        LEFT JOIN category c ON pi.category_id = c.category_id
        WHERE pu.part_number = #{partNumber}
        ORDER BY pu.used_date DESC
    </select>

    <!-- ✅ 카테고리별 조회 -->
    <select id="selectUsageByCategory" parameterType="int" resultMap="usageResultMap">
        SELECT
            pu.*,
            pi.part_name,
            pi.unit,
            c.category_name
        FROM part_usage pu
        LEFT JOIN part_incoming pi ON pu.incoming_id = pi.incoming_id
        LEFT JOIN category c ON pi.category_id = c.category_id
        WHERE pi.category_id = #{categoryId}
        ORDER BY pu.used_date DESC
    </select>

    <!-- ✅ 기간별 조회 (날짜 필터) -->
    <select id="selectUsageByDateRange" resultMap="usageResultMap">
        SELECT
            pu.*,
            pi.part_name,
            pi.unit,
            c.category_name
        FROM part_usage pu
        LEFT JOIN part_incoming pi ON pu.incoming_id = pi.incoming_id
        LEFT JOIN category c ON pi.category_id = c.category_id
        WHERE pu.used_date BETWEEN #{startDate} AND #{endDate}
        ORDER BY pu.used_date DESC
    </select>

    <!-- ✅ 정렬 (열 이름 + ASC/DESC 동적) -->
    <select id="sortUsage" resultMap="usageResultMap">
        SELECT
            pu.*,
            pi.part_name,
            pi.unit,
            c.category_name
        FROM part_usage pu
        LEFT JOIN part_incoming pi ON pu.incoming_id = pi.incoming_id
        LEFT JOIN category c ON pi.category_id = c.category_id
        ORDER BY ${column} ${order}
    </select>

    <!-- ✅ 부품별 사용 합계 (통계용) -->
    <select id="selectUsageSummaryByPart" resultType="map">
        SELECT
            pu.part_number,
            pi.part_name,
            c.category_name,
            SUM(pu.quantity_used) AS total_used
        FROM part_usage pu
        LEFT JOIN part_incoming pi ON pu.incoming_id = pi.incoming_id
        LEFT JOIN category c ON pi.category_id = c.category_id
        GROUP BY pu.part_number, pi.part_name, c.category_name
        ORDER BY total_used DESC
    </select>

    <!-- 검색 + 정렬 통합 -->
    <select id="searchWithSort" resultMap="usageResultMap">
        SELECT
            pu.*,
            pi.part_name,
            pi.unit,
            c.category_name
        FROM part_usage pu
        LEFT JOIN part_incoming pi ON pu.incoming_id = pi.incoming_id
        LEFT JOIN category c ON pi.category_id = c.category_id
        WHERE pi.part_name LIKE CONCAT('%', #{keyword}, '%')
        OR pu.usage_location LIKE CONCAT('%', #{keyword}, '%')
        OR pu.part_number LIKE CONCAT('%', #{keyword}, '%')
        ORDER BY ${column} ${order}
    </select>

</mapper>
